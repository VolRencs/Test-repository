name: _job_build
on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      dry_run:
        required: false
        type: boolean
        default: false

jobs:
  proton:
    name: Build ${{ inputs.name }}${{ inputs.dry_run && ' (DRY RUN)' || '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Dry-run mode – create fake artifacts and skip build
        if: ${{ inputs.dry_run }}
        run: |
          mkdir -p build
          echo "This is a dry-run build of ${{ inputs.name }}" > build/${{ inputs.name }}.tar.xz
          echo "dry-run fake file for testing release upload" >> build/${{ inputs.name }}.tar.xz
          sha512sum build/${{ inputs.name }}.tar.xz > build/${{ inputs.name }}.sha512sum
          echo "Dry-run artifacts created – build skipped"
          exit 0

      - name: Restore ccache
        if: ${{ !inputs.dry_run }}
        id: ccache
        uses: actions/cache/restore@v4
        with:
          path: ~/.ccache
          key: ccache-proton-v6-${{ runner.arch }}-${{ hashFiles('**/configure.sh', 'patches/**') }}
          restore-keys: |
            ccache-proton-v6-${{ runner.arch }}-

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: false

      - name: Apply patches
        if: ${{ !inputs.dry_run }}
        run: |
          git submodule update --init --filter=tree:0 --recursive
          ./patches/protonprep-valve-staging.sh || true
          patch -Np1 -i ./.github/patches/0001-build-strip-binaries-early.patch || true
          mkdir -p build

      - name: Build & package
        if: ${{ !inputs.dry_run }}
        working-directory: ./build
        run: |
          make -j$(nproc) redist
          echo "Disk usage after build:"
          df -h

      - name: Save ccache
        if: ${{ !inputs.dry_run && always() }}
        uses: actions/cache/save@v4
        with:
          path: ~/.ccache
          key: ${{ steps.ccache.outputs.cache-primary-key }}

      - name: Upload artifact ${{ inputs.name }}.tar.xz
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.name }}.tar.xz
          path: ./build/${{ inputs.name }}.tar.xz

      - name: Upload artifact ${{ inputs.name }}.sha512sum
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.name }}.sha512sum
          path: ./build/${{ inputs.name }}.sha512sum
