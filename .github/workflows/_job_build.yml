name: _job_build
on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      dry_run:
        required: false
        type: boolean
        default: false

jobs:
  proton:
    name: Build ${{ inputs.name }}${{ inputs.dry_run && ' (DRY RUN)' || '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: "[DRY RUN] Create fake artifacts"
        if: ${{ inputs.dry_run }}
        run: |
          mkdir -p build
          echo "DRY-RUN TEST BUILD - ${{ inputs.name }}" > build/${{ inputs.name }}.tar.xz
          echo "This file proves that artifact upload works" >> build/${{ inputs.name }}.tar.xz
          sha512sum build/${{ inputs.name }}.tar.xz > build/${{ inputs.name }}.sha512sum
          echo "Fake artifacts created successfully!"


      - name: Restore ccache
        if: ${{ !inputs.dry_run }}
        id: ccache
        uses: actions/cache/restore@v4
        with:
          path: ~/.ccache
          key: ccache-proton-v6-${{ runner.arch }}-${{ hashFiles('**/configure.sh', 'patches/**') }}
          restore-keys: |
            ccache-proton-v6-${{ runner.arch }}-


      - name: Save ccache
        if: ${{ !inputs.dry_run && always() }}
        uses: actions/cache/save@v4
        with:
          path: ~/.ccache
          key: ${{ steps.ccache.outputs.cache-primary-key }}

      - name: Upload artifact ${{ inputs.name }}.tar.xz
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.name }}.tar.xz
          path: ./build/${{ inputs.name }}.tar.xz

      - name: Upload artifact ${{ inputs.name }}.sha512sum
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.name }}.sha512sum
          path: ./build/${{ inputs.name }}.sha512sum
