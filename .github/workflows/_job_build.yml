name: _job_build
on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      dry_run:
        required: false
        type: boolean
        default: false

jobs:
  proton:
    name: Build ${{ inputs.name }}${{ inputs.dry_run && ' (DRY RUN)' || '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: "[DRY RUN] Create fake artifacts"
        if: ${{ inputs.dry_run }}
        run: |
          mkdir -p build
          echo "DRY-RUN TEST BUILD - ${{ inputs.name }}" > build/${{ inputs.name }}.tar.xz
          echo "This file proves that artifact upload works" >> build/${{ inputs.name }}.tar.xz
          sha512sum build/${{ inputs.name }}.tar.xz > build/${{ inputs.name }}.sha512sum
          echo "Fake artifacts created successfully!"

      - name: Create fake artifacts (dry-run or fallback)
        run: |
          mkdir -p build
          echo "TEST BUILD ${{ inputs.name }}"              > build/${{ inputs.name }}.tar.xz
          echo "Created at $(date)"                          >> build/${{ inputs.name }}.tar.xz
          echo "GitHub Run: ${{ github.run_id }}"            >> build/${{ inputs.name }}.tar.xz
          sha512sum build/${{ inputs.name }}.tar.xz         > build/${{ inputs.name }}.sha512sum
          echo "Fake artifacts successfully created in build/"

    - name: Ensure .git exists (required for gh cli)
        run: |
          if [ ! -d ".git" ]; then
            echo "No .git found â†’ initializing minimal git repo for 'gh' tool"
            git init -b main
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            echo "dummy file for gh cli" > README.md
            git add README.md
            git commit -m "init"
          fi

      - name: Save ccache
        if: ${{ !inputs.dry_run && always() }}
        uses: actions/cache/save@v4
        with:
          path: ~/.ccache
          key: ${{ steps.ccache.outputs.cache-primary-key }}

      - name: Upload artifact ${{ inputs.name }}.tar.xz
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.name }}.tar.xz
          path: ./build/${{ inputs.name }}.tar.xz

      - name: Upload artifact ${{ inputs.name }}.sha512sum
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.name }}.sha512sum
          path: ./build/${{ inputs.name }}.sha512sum
